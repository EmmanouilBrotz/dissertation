#!/bin/bash

################################################################################
# Ubuntu 24.04 Server Hardening Script
# Purpose: Harden Ubuntu 24.04 servers for dissertation security infrastructure
# Usage: sudo ./harden_ubuntu.sh
# Note: SSH key authentication will be configured separately
################################################################################

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging
LOG_FILE="/var/log/hardening_$(date +%Y%m%d_%H%M%S).log"
exec > >(tee -a "$LOG_FILE")
exec 2>&1

echo -e "${GREEN}================================${NC}"
echo -e "${GREEN}Ubuntu 24.04 Hardening Script${NC}"
echo -e "${GREEN}================================${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
   echo -e "${RED}Please run as root or with sudo${NC}"
   exit 1
fi

# Backup directory
BACKUP_DIR="/root/hardening_backups_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
echo -e "${YELLOW}[*] Backups will be stored in: $BACKUP_DIR${NC}"

################################################################################
# 1. SYSTEM UPDATES AND AUTOMATIC SECURITY PATCHING
################################################################################
echo -e "${GREEN}[+] Configuring system updates and automatic security patching...${NC}"

apt-get update
apt-get upgrade -y
apt-get dist-upgrade -y

# Install unattended-upgrades
apt-get install -y unattended-upgrades apt-listchanges

# Configure automatic security updates
cp /etc/apt/apt.conf.d/50unattended-upgrades "$BACKUP_DIR/" 2>/dev/null || true
cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'EOF'
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
EOF

cat > /etc/apt/apt.conf.d/20auto-upgrades << 'EOF'
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
EOF

systemctl enable unattended-upgrades
systemctl start unattended-upgrades

################################################################################
# 2. FILE INTEGRITY MONITORING (AIDE)
################################################################################
echo -e "${GREEN}[+] Installing and configuring AIDE (File Integrity Monitoring)...${NC}"

apt-get install -y aide aide-common

# Initialize AIDE database
echo -e "${YELLOW}[*] Initializing AIDE database (this may take a few minutes)...${NC}"
aideinit
mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# Schedule daily AIDE checks
cat > /etc/cron.daily/aide-check << 'EOF'
#!/bin/bash
/usr/bin/aide --check | mail -s "AIDE Report for $(hostname)" root
EOF
chmod +x /etc/cron.daily/aide-check

################################################################################
# 3. AUDIT SYSTEM (auditd)
################################################################################
echo -e "${GREEN}[+] Installing and configuring auditd...${NC}"

apt-get install -y auditd audispd-plugins

cp /etc/audit/auditd.conf "$BACKUP_DIR/" 2>/dev/null || true
cp /etc/audit/rules.d/audit.rules "$BACKUP_DIR/" 2>/dev/null || true

# Configure audit rules
cat > /etc/audit/rules.d/hardening.rules << 'EOF'
# Delete all existing rules
-D

# Buffer Size
-b 8192

# Failure Mode (0=silent 1=printk 2=panic)
-f 1

# Audit system calls
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change

# User/Group modifications
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# Network configuration changes
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/network -p wa -k system-locale

# Login/Logout events
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/log/tallylog -p wa -k logins

# Session initiation
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# Permission modifications
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod

# Unauthorized access attempts
-a always,exit -F arch=b64 -S open -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S open -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S open -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S open -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access

# Sudoers file changes
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

# Kernel module loading/unloading
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

# Make configuration immutable
-e 2
EOF

systemctl enable auditd
systemctl restart auditd

################################################################################
# 4. APPARMOR ENFORCEMENT
################################################################################
echo -e "${GREEN}[+] Configuring AppArmor...${NC}"

apt-get install -y apparmor apparmor-utils apparmor-profiles apparmor-profiles-extra

# Enable AppArmor
systemctl enable apparmor
systemctl start apparmor

# Set all profiles to enforce mode
aa-enforce /etc/apparmor.d/* 2>/dev/null || true

################################################################################
# 5. ANTIVIRUS (ClamAV)
################################################################################
echo -e "${GREEN}[+] Installing and configuring ClamAV...${NC}"

apt-get install -y clamav clamav-daemon clamav-freshclam

# Stop services to update
systemctl stop clamav-freshclam 2>/dev/null || true

# Update virus definitions
echo -e "${YELLOW}[*] Updating ClamAV virus definitions...${NC}"
freshclam

# Start services
systemctl enable clamav-freshclam
systemctl start clamav-freshclam
systemctl enable clamav-daemon
systemctl start clamav-daemon

# Create daily scan script
mkdir -p /var/log/clamav
cat > /etc/cron.daily/clamav-scan << 'EOF'
#!/bin/bash
SCAN_DIR="/"
EXCLUDE_DIR="--exclude-dir=/sys --exclude-dir=/proc --exclude-dir=/dev"
LOG_FILE="/var/log/clamav/daily-scan.log"
clamscan -r -i $EXCLUDE_DIR $SCAN_DIR >> $LOG_FILE 2>&1
EOF
chmod +x /etc/cron.daily/clamav-scan

################################################################################
# 6. FIREWALL (UFW)
################################################################################
echo -e "${GREEN}[+] Configuring UFW firewall...${NC}"

apt-get install -y ufw

# Default policies
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw default deny routed

# Rate limiting for SSH (will be configured per-VM basis)
# Note: SSH port will need to be opened separately per VM requirements

# Enable logging
ufw logging medium

# Configure log rotation for UFW
cat > /etc/logrotate.d/ufw << 'EOF'
/var/log/ufw.log {
    daily
    rotate 7
    missingok
    notifempty
    compress
    delaycompress
    sharedscripts
    postrotate
        /usr/sbin/invoke-rc.d rsyslog rotate >/dev/null 2>&1 || true
    endscript
}
EOF

# Enable UFW
echo -e "${YELLOW}[*] UFW will be enabled. Make sure SSH access is configured!${NC}"
echo -e "${YELLOW}[*] Add your SSH rule manually: ufw limit 22/tcp (or your custom port)${NC}"
# ufw --force enable  # Commented out - enable manually after SSH rule is added

################################################################################
# 7. INTRUSION PREVENTION (Fail2Ban)
################################################################################
echo -e "${GREEN}[+] Installing and configuring Fail2Ban...${NC}"

apt-get install -y fail2ban

cp /etc/fail2ban/jail.conf "$BACKUP_DIR/" 2>/dev/null || true

cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5
destemail = root@localhost
sendername = Fail2Ban
action = %(action_mwl)s

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 7200

[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 7200

[port-scan]
enabled = true
filter = port-scan
logpath = /var/log/syslog
maxretry = 3
bantime = 86400
EOF

# Port scan filter
cat > /etc/fail2ban/filter.d/port-scan.conf << 'EOF'
[Definition]
failregex = UFW BLOCK.* SRC=<HOST>
ignoreregex =
EOF

systemctl enable fail2ban
systemctl restart fail2ban

################################################################################
# 8. SSH HARDENING (Without Key-Only Auth Yet)
################################################################################
echo -e "${GREEN}[+] Hardening SSH configuration...${NC}"

cp /etc/ssh/sshd_config "$BACKUP_DIR/"

# Backup and configure SSH
cat > /etc/ssh/sshd_config << 'EOF'
# SSH Hardening Configuration

# Network
Port 22
AddressFamily inet
ListenAddress 0.0.0.0

# Authentication
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication yes
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes

# Kerberos and GSSAPI
KerberosAuthentication no
GSSAPIAuthentication no

# Security options
X11Forwarding no
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server

# Connection settings
ClientAliveInterval 300
ClientAliveCountMax 2
LoginGraceTime 60
MaxAuthTries 3
MaxSessions 10
MaxStartups 10:30:60

# Crypto hardening
Protocol 2
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Banner
Banner /etc/ssh/banner
EOF

# Create SSH banner
cat > /etc/ssh/banner << 'EOF'
***********************************************************************
*                                                                     *
*  AUTHORIZED ACCESS ONLY                                             *
*                                                                     *
*  Unauthorized access to this system is forbidden and will be        *
*  prosecuted by law. By accessing this system, you agree that your   *
*  actions may be monitored if unauthorized usage is suspected.       *
*                                                                     *
***********************************************************************
EOF

# Restart SSH (carefully)
echo -e "${YELLOW}[*] Restarting SSH service...${NC}"
systemctl restart sshd

################################################################################
# 9. KERNEL HARDENING (sysctl)
################################################################################
echo -e "${GREEN}[+] Applying kernel hardening parameters...${NC}"

cp /etc/sysctl.conf "$BACKUP_DIR/" 2>/dev/null || true

cat > /etc/sysctl.d/99-hardening.conf << 'EOF'
# Kernel Hardening Configuration

# IP Forwarding (disable unless this is a router)
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# Disable IPv6 (if not needed)
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

# SYN Flood Protection
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# IP Spoofing Protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Ignore ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Don't send ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Ignore ICMP ping requests
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore Bogus ICMP errors
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Log Martians (packets with impossible addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Kernel hardening
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2
kernel.yama.ptrace_scope = 2
kernel.unprivileged_bpf_disabled = 1
net.core.bpf_jit_harden = 2

# Disable core dumps
kernel.core_uses_pid = 1
fs.suid_dumpable = 0

# Memory protection
vm.mmap_min_addr = 65536

# Address Space Layout Randomization
kernel.randomize_va_space = 2
EOF

sysctl -p /etc/sysctl.d/99-hardening.conf

################################################################################
# 10. SYSTEM LIMITS AND RESOURCE RESTRICTIONS
################################################################################
echo -e "${GREEN}[+] Configuring system limits...${NC}"

cp /etc/security/limits.conf "$BACKUP_DIR/" 2>/dev/null || true

cat >> /etc/security/limits.conf << 'EOF'

# Hardening limits
* hard core 0
* soft nproc 1024
* hard nproc 2048
* soft nofile 4096
* hard nofile 8192
EOF

# Disable core dumps system-wide
cat > /etc/profile.d/disable-coredumps.sh << 'EOF'
ulimit -c 0
EOF
chmod +x /etc/profile.d/disable-coredumps.sh

################################################################################
# 11. ROOTKIT DETECTION
################################################################################
echo -e "${GREEN}[+] Installing rootkit detection tools...${NC}"

apt-get install -y rkhunter chkrootkit

# Configure rkhunter
cp /etc/rkhunter.conf "$BACKUP_DIR/" 2>/dev/null || true
rkhunter --update
rkhunter --propupd

# Schedule weekly scans
cat > /etc/cron.weekly/rkhunter-scan << 'EOF'
#!/bin/bash
/usr/bin/rkhunter --check --skip-keypress --report-warnings-only | mail -s "rkhunter Report for $(hostname)" root
EOF
chmod +x /etc/cron.weekly/rkhunter-scan

cat > /etc/cron.weekly/chkrootkit-scan << 'EOF'
#!/bin/bash
/usr/sbin/chkrootkit | mail -s "chkrootkit Report for $(hostname)" root
EOF
chmod +x /etc/cron.weekly/chkrootkit-scan

################################################################################
# 12. SECURITY AUDITING (Lynis)
################################################################################
echo -e "${GREEN}[+] Installing Lynis security auditing tool...${NC}"

apt-get install -y lynis

echo -e "${YELLOW}[*] Run 'sudo lynis audit system' to perform a security audit${NC}"

################################################################################
# 13. PACKAGE VERIFICATION
################################################################################
echo -e "${GREEN}[+] Installing package verification tools...${NC}"

apt-get install -y debsums

# Verify installed packages
echo -e "${YELLOW}[*] Verifying installed packages (this may take a while)...${NC}"
debsums -s 2>&1 | tee "$BACKUP_DIR/debsums_report.txt" || true

################################################################################
# 14. TIME SYNCHRONIZATION
################################################################################
echo -e "${GREEN}[+] Configuring time synchronization...${NC}"

# Ubuntu 24.04 uses systemd-timesyncd by default
systemctl enable systemd-timesyncd
systemctl start systemd-timesyncd

# Verify time sync
timedatectl set-ntp true
timedatectl status

################################################################################
# 15. DISABLE UNNECESSARY SERVICES
################################################################################
echo -e "${GREEN}[+] Disabling unnecessary services...${NC}"

# List of services to disable (adjust based on your needs)
SERVICES_TO_DISABLE=(
    "bluetooth.service"
    "cups.service"
    "cups-browsed.service"
    "avahi-daemon.service"
    "isc-dhcp-server.service"
    "isc-dhcp-server6.service"
    "nfs-server.service"
    "rpcbind.service"
)

for service in "${SERVICES_TO_DISABLE[@]}"; do
    if systemctl is-enabled "$service" 2>/dev/null | grep -q enabled; then
        echo -e "${YELLOW}[*] Disabling $service${NC}"
        systemctl disable "$service" 2>/dev/null || true
        systemctl stop "$service" 2>/dev/null || true
    fi
done

################################################################################
# 16. SECURE SHARED MEMORY
################################################################################
echo -e "${GREEN}[+] Securing shared memory...${NC}"

if ! grep -q "tmpfs.*\/run\/shm" /etc/fstab; then
    echo "tmpfs /run/shm tmpfs defaults,noexec,nodev,nosuid 0 0" >> /etc/fstab
fi

################################################################################
# 17. ACCOUNT SECURITY
################################################################################
echo -e "${GREEN}[+] Configuring account security policies...${NC}"

apt-get install -y libpam-pwquality

cp /etc/pam.d/common-password "$BACKUP_DIR/" 2>/dev/null || true
cp /etc/login.defs "$BACKUP_DIR/" 2>/dev/null || true

# Configure password quality requirements
cat > /etc/security/pwquality.conf << 'EOF'
# Password quality requirements
minlen = 14
dcredit = -1
ucredit = -1
ocredit = -1
lcredit = -1
minclass = 4
maxrepeat = 3
maxsequence = 3
difok = 5
gecoscheck = 1
dictcheck = 1
usercheck = 1
enforcing = 1
retry = 3
EOF

# Configure password aging
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   1/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   7/' /etc/login.defs

# Lock inactive accounts after 30 days
useradd -D -f 30

################################################################################
# 18. REMOVE UNNECESSARY PACKAGES
################################################################################
echo -e "${GREEN}[+] Removing unnecessary packages...${NC}"

apt-get autoremove -y
apt-get autoclean -y

################################################################################
# 19. SYSTEM INFORMATION COLLECTION
################################################################################
echo -e "${GREEN}[+] Collecting system information...${NC}"

cat > "$BACKUP_DIR/system_info.txt" << EOF
Hardening completed on: $(date)
Hostname: $(hostname)
Kernel: $(uname -r)
OS: $(lsb_release -d | cut -f2)
IP Address: $(hostname -I)
EOF

################################################################################
# FINAL STEPS
################################################################################
echo ""
echo -e "${GREEN}================================${NC}"
echo -e "${GREEN}Hardening Complete!${NC}"
echo -e "${GREEN}================================${NC}"
echo ""
echo -e "${YELLOW}IMPORTANT NEXT STEPS:${NC}"
echo ""
echo -e "1. ${RED}Configure UFW for SSH:${NC}"
echo -e "   sudo ufw limit 22/tcp  ${YELLOW}(or your custom SSH port)${NC}"
echo -e "   sudo ufw enable"
echo ""
echo -e "2. ${RED}Configure SSH key authentication${NC} (do this later as planned)"
echo ""
echo -e "3. ${RED}Review and customize firewall rules${NC} for this specific VM"
echo ""
echo -e "4. ${RED}Run security audit:${NC}"
echo -e "   sudo lynis audit system"
echo ""
echo -e "5. ${RED}Reboot the system${NC} to ensure all changes take effect:"
echo -e "   sudo reboot"
echo ""
echo -e "${GREEN}Logs and backups saved to: $BACKUP_DIR${NC}"
echo -e "${GREEN}Hardening log: $LOG_FILE${NC}"
echo ""
echo -e "${YELLOW}Remember: This script disabled password authentication preparation.${NC}"
echo -e "${YELLOW}You'll configure SSH keys later from the Jump Host.${NC}"
echo ""